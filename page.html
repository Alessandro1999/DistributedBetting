<!DOCTYPE html>
<html lang="en">
	<meta charset="utf-8">
	<head>
		<title>DBet</title>
		<!-- fancy styling of the page -->
    <link href="css/bootstrap.min.css" rel="stylesheet">
    <link href='https://fonts.googleapis.com/css?family=Poppins' rel='stylesheet'>
	</head>
	<body style="background-color:#201e26; font-family: 'Poppins';">
        <nav>
            <ul class="navbar nav-tabs">
                <li class="nav-item">
                    <a class="nav-link active" href="#" style="color:white; background-color: #201e26;">Bet</a>
                </li>
                <li class="nav-item">
                    <a class="nav-link" href="#" style="color:white">Market</a>
                </li>
                <li class="nav-item">
                    <a class="nav-link" href="#" style="color:white">Recap Bets</a>
                </li>
                <li class="nav-item ml-auto">
                    <a class="nav-link disabled" style="color:white">
                        <img src="img/entrytoken.webp" width="30" height="30" class="d-inline-block align-top" alt="">
                        <label id="entryTokens">0</label>
                    </a>
                </li>
                <li class="nav-item">
                        <a class="nav-link disabled" style="color:white">
                            <img src="img/supertoken.webp" width="30" height="30" class="d-inline-block align-top" alt="">
                            <label id="superTokens">0</label>
                        </a>
                </li>
                <li class="nav-item">
                    <a class="nav-link disabled" style="color:white">
                        <img src="img/ethereum.webp" width="30" height="30" class="d-inline-block align-top" alt="">
                        <label id="ether">0</label>
                    </a>
                <li class="nav-item">
                    <a class="nav-link disabled" style="color:white" id="address">0x...</a>
                </li>
            </ul>
        </nav>
		<main class="container">
			<div class="container border rounded" style="padding: 10px">
                <div class="row">
                    <div class="col-sm-12">
                        <h3 style="color:white">Mint some entryTokens</h3>
                    </div>
                    <div class="col-sm-12">
                        <label style="display: inline-block; width: 140px; color:white">Entry tokens:</label>
                        <input type="number" style="outline: #201e26;" id="quantity" name="quantity" min="1" placeholder="1" onchange="updateEthPrice(); return false;"></input>
                    </div>
                    <div class="col-sm-12">
                        <label style="display: inline-block; width: 140px; color: white;">Price (in ether):</label>
                        <input type="text" style="outline:#201e26;" id="entryEthPrice" name="entryEthPrice" min="1" placeholder="1" readonly></input>
                    </div>
                    <div class="col-sm-12">
                        <button type="button" class="btn btn-outline-light" onclick="mint()">Mint</button>
                    </div>
            </div>
		</main>
	</body>
<!-- Javascript libraries (to ease life) -->
<script src="js/jquery.min.js"></script>
<script src="js/bootstrap.min.js"></script>
<!--  Our connection to the blockchain -->
<script src="js/web3.min.js"></script>
<script>
    function updateEthPrice()
    {
        var quantity = parseInt(document.getElementById("quantity").value);
        var ethPrice = quantity * entryTokensPrice;
        document.getElementById("entryEthPrice").value = web3.utils.fromWei(ethPrice.toString(), "ether");
    }
    function updateEther()
    {
        web3.eth.getBalance(myAddress).then(function(result) {
            document.getElementById("ether").innerHTML = web3.utils.fromWei(result, "ether");
            });
    }
    function mint()
    {
        //TODO metamask (you're spending ether here!)
        var quantity = parseInt(document.getElementById("quantity").value);
        var ethPrice = quantity * entryTokensPrice;
        updateEther();
        if(ethPrice > web3.utils.toWei(document.getElementById("ether").innerHTML, "ether"))
        {
            alert("Not enough ether");
            return;
        }
        else
        {
            contract.methods.mint().send({from: myAddress, value: ethPrice}).then(function(result) {
            document.getElementById("entryTokens").innerHTML = parseInt(document.getElementById("entryTokens").innerHTML) + quantity;
            updateEther();
            alert("Congratulations! You have minted " + quantity + " entryTokens");
            });
        }
       
    }
</script>
<script>
    if (typeof web3 !== 'undefined') {
	  web3 = new Web3(web3.currentProvider);
	} else {
	  // set the provider you want from Web3.providers
	  web3 = new Web3(new Web3.providers.HttpProvider("http://localhost:7545"));
	}
    
    var entryTokensPrice = 0;
    var myAddress = sessionStorage.getItem("address");
    var ABI = JSON.parse(sessionStorage.getItem("ABI"));
    var contract = new web3.eth.Contract(ABI, sessionStorage.getItem("contractAddress"));

    
    document.getElementById("address").innerHTML = myAddress;
    
    contract.methods.PRICE().call().then(function(result) {
        entryTokensPrice = result;
        document.getElementById("entryEthPrice").value = web3.utils.fromWei(result, "ether");
        document.getElementById("entryEthPrice").min = web3.utils.fromWei(result, "ether");
        });
    contract.methods.entryTokens(myAddress).call().then(function(result) {
        document.getElementById("entryTokens").innerHTML = result;
         });
    contract.methods.superTokens(myAddress).call().then(function(result) {
        document.getElementById("superTokens").innerHTML = result;
         });
    web3.eth.getBalance(myAddress).then(function(result) {
        document.getElementById("ether").innerHTML = web3.utils.fromWei(result, "ether");
        });
</script>
